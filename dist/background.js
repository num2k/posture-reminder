(()=>{var c=(e,o,t)=>new Promise((n,r)=>{var i=s=>{try{a(t.next(s))}catch(g){r(g)}},u=s=>{try{a(t.throw(s))}catch(g){r(g)}},a=s=>s.done?n(s.value):Promise.resolve(s.value).then(i,u);a((t=t.apply(e,o)).next())});var h={interval:5,notifications:!0,exercises:!0,language:"en",categories:{neck:!0,shoulder:!0,back:!0,wrist:!0,eye:!0,arm:!0},timerStarted:!1},y="postureReminderAlarm",k="autoClose_",D="wakeUpServiceWorker",I={en:{title:"Posture Reminder",breakTime:"Break Time",breakTimeDesc:"Take a short break and do some stretching!",remindLater:"Remind in 5 minutes",stretchNow:"Stretch now"},ko:{title:"\uC790\uC138 \uC54C\uB9BC\uC774",breakTime:"\uD734\uC2DD \uC2DC\uAC04",breakTimeDesc:"\uC7A0\uC2DC \uD734\uC2DD\uC744 \uCDE8\uD558\uACE0 \uC2A4\uD2B8\uB808\uCE6D\uC744 \uD574\uBCF4\uC138\uC694!",remindLater:"5\uBD84 \uD6C4\uC5D0 \uC54C\uB9BC",stretchNow:"\uC9C0\uAE08 \uC2A4\uD2B8\uB808\uCE6D"}},l=[],f=!1,T=null,m=new Map,$=Date.now(),L=null,p=null;function d(e,o){return(!o||!I[o])&&(o="en"),I[o][e]||I.en[e]}function v(e){return c(this,null,function*(){e=e||"en";let o=e==="ko"?"data/exercises_kr.json":"data/exercises.json";try{console.log(`\uC6B4\uB3D9 \uB370\uC774\uD130 \uB85C\uB4DC \uC911... \uC5B8\uC5B4: ${e}, \uD30C\uC77C: ${o}`);let t=yield fetch(o);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return l=yield t.json(),console.log(`\uC6B4\uB3D9 \uB370\uC774\uD130 \uB85C\uB4DC \uC644\uB8CC: ${l.length}\uAC1C \uD56D\uBAA9`),l}catch(t){return console.error(`\uC6B4\uB3D9 \uB370\uC774\uD130 \uB85C\uB4DC \uC2E4\uD328: ${t.message}`),l=[{id:1,title:d("breakTime",e),category:"general",description:d("breakTimeDesc",e)}],console.log(`\uAE30\uBCF8 \uBA54\uC2DC\uC9C0 \uC0AC\uC6A9: ${l.length}\uAC1C \uD56D\uBAA9`),l}})}function x(){return c(this,null,function*(){return new Promise(e=>{chrome.storage.sync.get(["settings"],function(o){let t=o.settings||h;T=t,e(t)})})})}function _(){return c(this,null,function*(){let e=yield x();yield F(),yield v(e.language),f=!0,e.timerStarted?(N(e.interval),E()):console.log("\uD0C0\uC774\uBA38\uAC00 \uC2DC\uC791\uB418\uC9C0 \uC54A\uC558\uC74C \uC54C\uB78C\uC744 \uC124\uC815\uD558\uC9C0 \uC54A\uC74C"),w(),H()})}function H(){L&&clearInterval(L),L=setInterval(()=>{P(),w()},3e4)}function E(){chrome.alarms.clear(D,()=>{chrome.alarms.create(D,{delayInMinutes:.5,periodInMinutes:.5}),console.log("\uC11C\uBE44\uC2A4 \uC6CC\uCEE4 \uD65C\uC131\uD654 \uC54C\uB78C\uC774 30\uCD08 \uAC04\uACA9\uC73C\uB85C \uC124\uC815\uB428")})}function w(){$=Date.now(),console.log("\uC11C\uBE44\uC2A4\uC6CC\uCEE4 \uD65C\uC131\uD654 \uC0C1\uD0DC \uC5C5\uB370\uC774\uD2B8: "+new Date().toLocaleTimeString()),chrome.storage.local.set({lastActiveTimestamp:$,serviceWorkerActive:!0})}function N(e){chrome.alarms.clear(y,()=>{chrome.alarms.create(y,{delayInMinutes:e,periodInMinutes:e}),console.log(`\uC54C\uB78C\uC774 ${e}\uBD84 \uAC04\uACA9\uC73C\uB85C \uC124\uC815\uB428`),console.log(`\uB2E4\uC74C \uC54C\uB78C \uC608\uC815 \uC2DC\uAC04: ${new Date(Date.now()+e*60*1e3).toLocaleTimeString()}`)})}function C(e){chrome.alarms.clear(y,()=>{chrome.storage.sync.get(["settings"],function(o){let n=(o.settings||h).interval;chrome.alarms.create(y,{delayInMinutes:e,periodInMinutes:n}),console.log(`\uC54C\uB78C\uC774 ${e.toFixed(2)}\uBD84 \uD6C4\uC5D0 \uC124\uC815\uB428, \uC774\uD6C4 ${n}\uBD84 \uAC04\uACA9\uC73C\uB85C \uBC18\uBCF5`),console.log(`\uB2E4\uC74C \uC54C\uB78C \uC608\uC815 \uC2DC\uAC04: ${new Date(Date.now()+e*60*1e3).toLocaleTimeString()}`)})})}chrome.alarms.onAlarm.addListener(e=>c(void 0,null,function*(){if(console.log(`\uC54C\uB78C \uBC1C\uC0DD: ${e.name}`),e.name===D){w();let o=yield x();if(o.timerStarted&&!o.isPaused){P();let t=yield U();t&&t-Date.now()<6e4&&(console.log("\uC54C\uB9BC \uD45C\uC2DC \uC900\uBE44 \uC911..."),f||(yield v(o.language),f=!0))}return}if(e.name.startsWith(k)){let o=e.name.replace(k,"");console.log(`\uC54C\uB9BC \uC790\uB3D9 \uB2EB\uAE30 \uC2E4\uD589: ${o}`),yield b(o),m.delete(o),A();return}if(e.name===y)try{let o=yield x();if(w(),o.isPaused){console.log("\uC77C\uC2DC \uC815\uC9C0 \uC0C1\uD0DC\uC774\uBBC0\uB85C \uC54C\uB9BC\uC744 \uD45C\uC2DC\uD558\uC9C0 \uC54A\uC74C");return}if(!o.notifications){console.log("\uC54C\uB9BC\uC774 \uBE44\uD65C\uC131\uD654 \uB418\uC5B4\uC788\uC74C");return}if(o.workHoursOnly&&!O(o.workStart,o.workEnd)){console.log("\uD604\uC7AC \uC2DC\uAC04\uC774 \uADFC\uBB34 \uC2DC\uAC04\uC774 \uC544\uB2C8\uBBC0\uB85C \uC54C\uB9BC\uC744 \uD45C\uC2DC\uD558\uC9C0 \uC54A\uC74C");return}(!f||l.length===0)&&(yield v(o.language),f=!0),p=yield W(o),yield j(o)}catch(o){console.error("\uC54C\uB78C \uCC98\uB9AC \uC911 \uC624\uB958 \uBC1C\uC0DD:",o)}}));function U(){return new Promise(e=>{chrome.alarms.get(y,o=>{e(o?o.scheduledTime:null)})})}function W(e){return c(this,null,function*(){let o=e.language||"en",t={title:d("breakTime",o),description:d("breakTimeDesc",o)};if(e.exercises&&l.length>0){let n=l.filter(r=>{let i=e.categories||h.categories;return i[r.category]===void 0?!0:i[r.category]===!0});if(n.length===0)console.log("\uC120\uD0DD\uB41C \uCE74\uD14C\uACE0\uB9AC\uC5D0 \uC0AC\uC6A9 \uAC00\uB2A5\uD55C \uC6B4\uB3D9\uC5C6\uC74C. \uAE30\uBCF8 \uBA54\uC2DC\uC9C0\uB97C \uC0AC\uC6A9 \uD568.");else{let r=Math.floor(Math.random()*n.length);t=n[r],console.log(`\uC120\uD0DD\uB41C \uC6B4\uB3D9: ${t.title} (${t.category})`)}}return t})}function O(e,o){let t=new Date,n=t.getHours(),r=t.getMinutes(),[i,u]=e.split(":").map(Number),[a,s]=o.split(":").map(Number),g=n*60+r,S=i*60+u,M=a*60+s;return console.log(`\uD604\uC7AC \uC2DC\uAC04: ${n}:${r} (${g}\uBD84)`),console.log(`\uADFC\uBB34 \uC2DC\uC791: ${i}:${u} (${S}\uBD84)`),console.log(`\uADFC\uBB34 \uC885\uB8CC: ${a}:${s} (${M}\uBD84)`),M<S?g>=S||g<=M:g>=S&&g<=M}function j(e){return c(this,null,function*(){console.log("\uC54C\uB9BC \uD45C\uC2DC \uC911...");let o=e.language||"en",t=p||(yield W(e)),n="posture-reminder-"+Date.now();try{yield new Promise((u,a)=>{chrome.notifications.create(n,{type:"basic",iconUrl:"assets/images/icon128.png",title:d("title",o),message:`${t.title}: ${t.description}`,priority:2,buttons:[{title:d("remindLater",o)},{title:d("stretchNow",o)}],requireInteraction:!0,silent:!1},s=>{chrome.runtime.lastError?a(chrome.runtime.lastError):u(s)})});let r=e.interval*60+5,i=Date.now()+r*1e3;chrome.alarms.create(k+n,{delayInMinutes:r/60}),m.set(n,i),A(),console.log(`\uC54C\uB9BC \uD45C\uC2DC\uB428: ${n}, \uC790\uB3D9 \uB2EB\uAE30 \uC608\uC815: ${r}\uCD08 \uD6C4`)}catch(r){console.error("\uC54C\uB9BC \uC0DD\uC131 \uC911 \uC624\uB958 \uBC1C\uC0DD:",r)}})}function A(){let e={};for(let[o,t]of m.entries())e[o]=t;chrome.storage.local.set({activeNotifications:e},()=>{console.log("\uD65C\uC131 \uC54C\uB9BC \uC815\uBCF4\uAC00 \uC800\uC7A5\uB428:",Object.keys(e).length+"\uAC1C")})}function F(){return c(this,null,function*(){return new Promise(e=>{chrome.storage.local.get(["activeNotifications"],o=>c(this,null,function*(){let t=o.activeNotifications||{};m.clear();let n=Date.now(),r=0;for(let[i,u]of Object.entries(t))if(u>n){m.set(i,u);let a=Math.max(0,(u-n)/1e3);a>0&&(chrome.alarms.create(k+i,{delayInMinutes:a/60}),r++)}else yield b(i);console.log(`\uD65C\uC131 \uC54C\uB9BC \uC815\uBCF4\uAC00 \uBCF5\uC6D0\uB428: ${r}\uAC1C`),e()}))})})}function b(e){return new Promise(o=>{chrome.notifications.clear(e,t=>{o(t)})})}chrome.notifications.onButtonClicked.addListener((e,o)=>c(void 0,null,function*(){chrome.alarms.clear(k+e),m.delete(e),A(),o===0?C(5):chrome.tabs.create({url:"popup/stretching_guide.html"}),yield b(e)}));chrome.notifications.onClosed.addListener(e=>{chrome.alarms.clear(k+e),m.delete(e),A(),console.log(`\uC54C\uB9BC \uB2EB\uD798: ${e}`)});chrome.storage.onChanged.addListener((e,o)=>c(void 0,null,function*(){if(o==="sync"&&e.settings){let t=e.settings.newValue;T=t,t.timerStarted&&!t.isPaused?(N(t.interval),console.log(`\uC124\uC815 \uBCC0\uACBD \uAC10\uC9C0: \uD0C0\uC774\uBA38 \uC2DC\uC791\uB428, ${t.interval}\uBD84 \uAC04\uACA9\uC73C\uB85C \uC54C\uB78C \uC124\uC815`)):console.log("\uC124\uC815 \uBCC0\uACBD \uAC10\uC9C0: \uD0C0\uC774\uBA38 \uC2DC\uC791\uB418\uC9C0 \uC54A\uC558\uAC70\uB098 \uC77C\uC2DC \uC815\uC9C0 \uC0C1\uD0DC, \uC54C\uB78C \uC124\uC815 \uC548 \uD568"),(!e.settings.oldValue||e.settings.oldValue.language!==t.language)&&(yield v(t.language),f=!0)}}));chrome.runtime.onMessage.addListener((e,o,t)=>{if(console.log("\uBA54\uC2DC\uC9C0 \uC218\uC2E0:",e.action),w(),e.action==="resetAlarm")return chrome.storage.sync.get(["settings"],function(n){let r=n.settings||h;T=r,r.timerStarted?(N(r.interval),console.log("\uD0C0\uC774\uBA38\uAC00 \uC2DC\uC791\uB428: \uC54C\uB78C \uC124\uC815\uB428"),t&&t({success:!0,message:"\uC54C\uB78C \uC124\uC815\uB428"})):(console.log("\uD0C0\uC774\uBA38\uAC00 \uC2DC\uC791\uB418\uC9C0 \uC54A\uC558\uC74C: \uC54C\uB78C\uC744 \uC124\uC815\uD558\uC9C0 \uC54A\uC74C"),t&&t({success:!1,message:"\uD0C0\uC774\uBA38 \uC911\uC9C0\uB428"}))}),!0;if(e.action==="resumeAlarm"&&e.delayInMinutes)return C(e.delayInMinutes),t&&t({success:!0,message:"\uC54C\uB78C \uC7AC\uAC1C"}),!0;if(e.action==="startTimer")return chrome.storage.sync.get(["settings"],function(n){let r=n.settings||h;r.timerStarted=!0,r.isPaused=!1,T=r,chrome.storage.sync.set({settings:r},function(){N(r.interval),E(),console.log("\uD0C0\uC774\uBA38 \uC2DC\uC791 \uC694\uCCAD: \uC54C\uB78C \uC124\uC815\uB428"),t&&t({success:!0,message:"\uD0C0\uC774\uBA38 \uC2DC\uC791"})})}),!0;if(e.action==="stopTimer")return chrome.storage.sync.get(["settings"],function(n){let r=n.settings||h;r.timerStarted=!1,r.isPaused=!1,T=r,chrome.storage.sync.set({settings:r},function(){chrome.alarms.clear(y),chrome.alarms.clear(D),console.log("\uD0C0\uC774\uBA38 \uC911\uC9C0 \uC694\uCCAD: \uBAA8\uB4E0 \uC54C\uB78C \uC81C\uAC70"),t&&t({success:!0,message:"\uD0C0\uC774\uBA38 \uC911\uC9C0"})})}),!0;if(e.action==="getExercises")return!f||l.length===0?x().then(n=>{v(n.language).then(r=>{f=!0,t&&t({success:!0,exercises:r})})}):t&&t({success:!0,exercises:l}),!0;if(e.action==="keepAlive")return console.log("\uD0B5\uC5BC\uB77C\uC774\uBE0C \uBA54\uC2DC\uC9C0 \uC218\uC2E0, \uC11C\uBE44\uC2A4 \uC6CC\uCEE4 \uD65C\uC131 \uC720\uC9C0"),w(),t&&t({success:!0,timestamp:$}),!0;if(e.action==="checkNotifications")return P(),t&&t({success:!0,activeCount:m.size,lastActive:$}),!0;if(e.action==="wakeUpServiceWorker")return console.log("\uC11C\uBE44\uC2A4 \uC6CC\uCEE4 \uC6E8\uC774\uD06C\uC5C5 \uC694\uCCAD \uBC1B\uC74C"),w(),chrome.storage.sync.get(["settings"],function(n){let r=n.settings||h;r.timerStarted&&!r.isPaused&&E(),t&&t({success:!0,active:!0,timestamp:$})}),!0});function P(){return c(this,null,function*(){console.log("\uC54C\uB9BC \uC0C1\uD0DC \uD655\uC778 \uBC0F \uC815\uB9AC \uC911...");let e=Date.now(),o=0;for(let[t,n]of m.entries())n<=e&&(yield b(t),chrome.alarms.clear(k+t),m.delete(t),o++);o>0&&(console.log(`${o}\uAC1C\uC758 \uB9CC\uB8CC\uB41C \uC54C\uB9BC\uC744 \uC815\uB9AC`),A())})}_();})();
