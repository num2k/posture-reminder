(()=>{var s=(e,o,t)=>new Promise((n,r)=>{var i=c=>{try{l(t.next(c))}catch(k){r(k)}},m=c=>{try{l(t.throw(c))}catch(k){r(k)}},l=c=>c.done?n(c.value):Promise.resolve(c.value).then(i,m);l((t=t.apply(e,o)).next())});var f={interval:5,notifications:!0,exercises:!0,language:"en",categories:{neck:!0,shoulder:!0,back:!0,wrist:!0,eye:!0,arm:!0},timerStarted:!1},w="postureReminderAlarm",y="autoClose_",M="wakeUpServiceWorker",N={en:{title:"Posture Reminder",breakTime:"Break Time",breakTimeDesc:"Take a short break and do some stretching!",remindLater:"Remind in 5 minutes",stretchNow:"Stretch now"},ko:{title:"\uC790\uC138 \uC54C\uB9BC\uC774",breakTime:"\uD734\uC2DD \uC2DC\uAC04",breakTimeDesc:"\uC7A0\uC2DC \uD734\uC2DD\uC744 \uCDE8\uD558\uACE0 \uC2A4\uD2B8\uB808\uCE6D\uC744 \uD574\uBCF4\uC138\uC694!",remindLater:"5\uBD84 \uD6C4\uC5D0 \uC54C\uB9BC",stretchNow:"\uC9C0\uAE08 \uC2A4\uD2B8\uB808\uCE6D"}},a=[],g=!1,T=null,u=new Map,v=Date.now(),b=null,E=null;function h(e,o){return(!o||!N[o])&&(o="en"),N[o][e]||N.en[e]}function A(e){return s(this,null,function*(){e=e||"en";let o=e==="ko"?"data/exercises_kr.json":"data/exercises.json";try{console.log(`\uC6B4\uB3D9 \uB370\uC774\uD130 \uB85C\uB4DC \uC911... \uC5B8\uC5B4: ${e}, \uD30C\uC77C: ${o}`);let t=yield fetch(o);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return a=yield t.json(),console.log(`\uC6B4\uB3D9 \uB370\uC774\uD130 \uB85C\uB4DC \uC644\uB8CC: ${a.length}\uAC1C \uD56D\uBAA9`),a}catch(t){return console.error(`\uC6B4\uB3D9 \uB370\uC774\uD130 \uB85C\uB4DC \uC2E4\uD328: ${t.message}`),a=[{id:1,title:h("breakTime",e),category:"general",description:h("breakTimeDesc",e)}],console.log(`\uAE30\uBCF8 \uBA54\uC2DC\uC9C0 \uC0AC\uC6A9: ${a.length}\uAC1C \uD56D\uBAA9`),a}})}function $(){return s(this,null,function*(){return new Promise(e=>{chrome.storage.sync.get(["settings"],function(o){let t=o.settings||f;T=t,e(t)})})})}function _(){return s(this,null,function*(){let e=yield $();yield F(),yield A(e.language),g=!0,e.timerStarted?(D(e.interval),I()):console.log("\uD0C0\uC774\uBA38\uAC00 \uC2DC\uC791\uB418\uC9C0 \uC54A\uC558\uC74C \uC54C\uB78C\uC744 \uC124\uC815\uD558\uC9C0 \uC54A\uC74C"),d(),H()})}function H(){b&&clearInterval(b),b=setInterval(()=>{L(),d()},3e4)}function I(){chrome.alarms.clear(M,()=>{chrome.alarms.create(M,{delayInMinutes:.5,periodInMinutes:.5}),console.log("\uC11C\uBE44\uC2A4 \uC6CC\uCEE4 \uD65C\uC131\uD654 \uC54C\uB78C\uC774 30\uCD08 \uAC04\uACA9\uC73C\uB85C \uC124\uC815\uB428")})}function d(){v=Date.now(),console.log("\uC11C\uBE44\uC2A4\uC6CC\uCEE4 \uD65C\uC131\uD654 \uC0C1\uD0DC \uC5C5\uB370\uC774\uD2B8: "+new Date().toLocaleTimeString()),chrome.storage.local.set({lastActiveTimestamp:v,serviceWorkerActive:!0})}function D(e){chrome.alarms.clear(w,()=>{chrome.alarms.create(w,{delayInMinutes:e,periodInMinutes:e}),console.log(`\uC54C\uB78C\uC774 ${e}\uBD84 \uAC04\uACA9\uC73C\uB85C \uC124\uC815\uB428`),console.log(`\uB2E4\uC74C \uC54C\uB78C \uC608\uC815 \uC2DC\uAC04: ${new Date(Date.now()+e*60*1e3).toLocaleTimeString()}`)})}function P(e){chrome.alarms.clear(w,()=>{chrome.storage.sync.get(["settings"],function(o){let n=(o.settings||f).interval;chrome.alarms.create(w,{delayInMinutes:e,periodInMinutes:n}),console.log(`\uC54C\uB78C\uC774 ${e.toFixed(2)}\uBD84 \uD6C4\uC5D0 \uC124\uC815\uB428, \uC774\uD6C4 ${n}\uBD84 \uAC04\uACA9\uC73C\uB85C \uBC18\uBCF5`),console.log(`\uB2E4\uC74C \uC54C\uB78C \uC608\uC815 \uC2DC\uAC04: ${new Date(Date.now()+e*60*1e3).toLocaleTimeString()}`)})})}chrome.alarms.onAlarm.addListener(e=>s(void 0,null,function*(){if(console.log(`\uC54C\uB78C \uBC1C\uC0DD: ${e.name}`),e.name===M){d();let o=yield $();if(o.timerStarted&&!o.isPaused){L();let t=yield U();t&&t-Date.now()<6e4&&(console.log("\uC54C\uB9BC \uD45C\uC2DC \uC900\uBE44 \uC911..."),g||(yield A(o.language),g=!0))}return}if(e.name.startsWith(y)){let o=e.name.replace(y,"");console.log(`\uC54C\uB9BC \uC790\uB3D9 \uB2EB\uAE30 \uC2E4\uD589: ${o}`),yield x(o),u.delete(o),S();return}if(e.name===w)try{let o=yield $();if(d(),o.isPaused){console.log("\uC77C\uC2DC \uC815\uC9C0 \uC0C1\uD0DC\uC774\uBBC0\uB85C \uC54C\uB9BC\uC744 \uD45C\uC2DC\uD558\uC9C0 \uC54A\uC74C");return}if(!o.notifications){console.log("\uC54C\uB9BC\uC774 \uBE44\uD65C\uC131\uD654 \uB418\uC5B4\uC788\uC74C");return}if(o.workHoursOnly&&!O(o.workStart,o.workEnd)){console.log("\uD604\uC7AC \uC2DC\uAC04\uC774 \uADFC\uBB34 \uC2DC\uAC04\uC774 \uC544\uB2C8\uBBC0\uB85C \uC54C\uB9BC\uC744 \uD45C\uC2DC\uD558\uC9C0 \uC54A\uC74C");return}(!g||a.length===0)&&(yield A(o.language),g=!0),E=yield p(o),yield j(o)}catch(o){console.error("\uC54C\uB78C \uCC98\uB9AC \uC911 \uC624\uB958 \uBC1C\uC0DD:",o)}}));function U(){return new Promise(e=>{chrome.alarms.get(w,o=>{e(o?o.scheduledTime:null)})})}function p(e){return s(this,null,function*(){let o=e.language||"en",t={title:h("breakTime",o),description:h("breakTimeDesc",o)};if(e.exercises&&a.length>0){let n=a.filter(r=>{let i=e.categories||f.categories;return i[r.category]===void 0?!0:i[r.category]===!0});if(n.length===0)console.log("\uC120\uD0DD\uB41C \uCE74\uD14C\uACE0\uB9AC\uC5D0 \uC0AC\uC6A9 \uAC00\uB2A5\uD55C \uC6B4\uB3D9\uC5C6\uC74C. \uAE30\uBCF8 \uBA54\uC2DC\uC9C0\uB97C \uC0AC\uC6A9 \uD568.");else{let r=Math.floor(Math.random()*n.length);t=n[r],console.log(`\uC120\uD0DD\uB41C \uC6B4\uB3D9: ${t.title} (${t.category})`)}}return t})}function O(e,o){let t=new Date,n=t.getHours(),r=t.getMinutes(),[i,m]=e.split(":").map(Number),[l,c]=o.split(":").map(Number),k=n*60+r,C=i*60+m,W=l*60+c;return k>=C&&k<=W}function j(e){return s(this,null,function*(){console.log("\uC54C\uB9BC \uD45C\uC2DC \uC911...");let o=e.language||"en",t=E||(yield p(e)),n="posture-reminder-"+Date.now();try{yield new Promise((m,l)=>{chrome.notifications.create(n,{type:"basic",iconUrl:"assets/images/icon128.png",title:h("title",o),message:`${t.title}: ${t.description}`,priority:2,buttons:[{title:h("remindLater",o)},{title:h("stretchNow",o)}],requireInteraction:!0,silent:!1},c=>{chrome.runtime.lastError?l(chrome.runtime.lastError):m(c)})});let r=e.interval*60+5,i=Date.now()+r*1e3;chrome.alarms.create(y+n,{delayInMinutes:r/60}),u.set(n,i),S(),console.log(`\uC54C\uB9BC \uD45C\uC2DC\uB428: ${n}, \uC790\uB3D9 \uB2EB\uAE30 \uC608\uC815: ${r}\uCD08 \uD6C4`)}catch(r){console.error("\uC54C\uB9BC \uC0DD\uC131 \uC911 \uC624\uB958 \uBC1C\uC0DD:",r)}})}function S(){let e={};for(let[o,t]of u.entries())e[o]=t;chrome.storage.local.set({activeNotifications:e},()=>{console.log("\uD65C\uC131 \uC54C\uB9BC \uC815\uBCF4\uAC00 \uC800\uC7A5\uB428:",Object.keys(e).length+"\uAC1C")})}function F(){return s(this,null,function*(){return new Promise(e=>{chrome.storage.local.get(["activeNotifications"],o=>s(this,null,function*(){let t=o.activeNotifications||{};u.clear();let n=Date.now(),r=0;for(let[i,m]of Object.entries(t))if(m>n){u.set(i,m);let l=Math.max(0,(m-n)/1e3);l>0&&(chrome.alarms.create(y+i,{delayInMinutes:l/60}),r++)}else yield x(i);console.log(`\uD65C\uC131 \uC54C\uB9BC \uC815\uBCF4\uAC00 \uBCF5\uC6D0\uB428: ${r}\uAC1C`),e()}))})})}function x(e){return new Promise(o=>{chrome.notifications.clear(e,t=>{o(t)})})}chrome.notifications.onButtonClicked.addListener((e,o)=>s(void 0,null,function*(){chrome.alarms.clear(y+e),u.delete(e),S(),o===0?P(5):chrome.tabs.create({url:"popup/stretching_guide.html"}),yield x(e)}));chrome.notifications.onClosed.addListener(e=>{chrome.alarms.clear(y+e),u.delete(e),S(),console.log(`\uC54C\uB9BC \uB2EB\uD798: ${e}`)});chrome.storage.onChanged.addListener((e,o)=>s(void 0,null,function*(){if(o==="sync"&&e.settings){let t=e.settings.newValue;T=t,t.timerStarted&&!t.isPaused?(D(t.interval),console.log(`\uC124\uC815 \uBCC0\uACBD \uAC10\uC9C0: \uD0C0\uC774\uBA38 \uC2DC\uC791\uB428, ${t.interval}\uBD84 \uAC04\uACA9\uC73C\uB85C \uC54C\uB78C \uC124\uC815`)):console.log("\uC124\uC815 \uBCC0\uACBD \uAC10\uC9C0: \uD0C0\uC774\uBA38 \uC2DC\uC791\uB418\uC9C0 \uC54A\uC558\uAC70\uB098 \uC77C\uC2DC \uC815\uC9C0 \uC0C1\uD0DC, \uC54C\uB78C \uC124\uC815 \uC548 \uD568"),(!e.settings.oldValue||e.settings.oldValue.language!==t.language)&&(yield A(t.language),g=!0)}}));chrome.runtime.onMessage.addListener((e,o,t)=>{if(console.log("\uBA54\uC2DC\uC9C0 \uC218\uC2E0:",e.action),d(),e.action==="resetAlarm")return chrome.storage.sync.get(["settings"],function(n){let r=n.settings||f;T=r,r.timerStarted?(D(r.interval),console.log("\uD0C0\uC774\uBA38\uAC00 \uC2DC\uC791\uB428: \uC54C\uB78C \uC124\uC815\uB428"),t&&t({success:!0,message:"\uC54C\uB78C \uC124\uC815\uB428"})):(console.log("\uD0C0\uC774\uBA38\uAC00 \uC2DC\uC791\uB418\uC9C0 \uC54A\uC558\uC74C: \uC54C\uB78C\uC744 \uC124\uC815\uD558\uC9C0 \uC54A\uC74C"),t&&t({success:!1,message:"\uD0C0\uC774\uBA38 \uC911\uC9C0\uB428"}))}),!0;if(e.action==="resumeAlarm"&&e.delayInMinutes)return P(e.delayInMinutes),t&&t({success:!0,message:"\uC54C\uB78C \uC7AC\uAC1C"}),!0;if(e.action==="startTimer")return chrome.storage.sync.get(["settings"],function(n){let r=n.settings||f;r.timerStarted=!0,r.isPaused=!1,T=r,chrome.storage.sync.set({settings:r},function(){D(r.interval),I(),console.log("\uD0C0\uC774\uBA38 \uC2DC\uC791 \uC694\uCCAD: \uC54C\uB78C \uC124\uC815\uB428"),t&&t({success:!0,message:"\uD0C0\uC774\uBA38 \uC2DC\uC791"})})}),!0;if(e.action==="stopTimer")return chrome.storage.sync.get(["settings"],function(n){let r=n.settings||f;r.timerStarted=!1,r.isPaused=!1,T=r,chrome.storage.sync.set({settings:r},function(){chrome.alarms.clear(w),chrome.alarms.clear(M),console.log("\uD0C0\uC774\uBA38 \uC911\uC9C0 \uC694\uCCAD: \uBAA8\uB4E0 \uC54C\uB78C \uC81C\uAC70"),t&&t({success:!0,message:"\uD0C0\uC774\uBA38 \uC911\uC9C0"})})}),!0;if(e.action==="getExercises")return!g||a.length===0?$().then(n=>{A(n.language).then(r=>{g=!0,t&&t({success:!0,exercises:r})})}):t&&t({success:!0,exercises:a}),!0;if(e.action==="keepAlive")return console.log("\uD0B5\uC5BC\uB77C\uC774\uBE0C \uBA54\uC2DC\uC9C0 \uC218\uC2E0, \uC11C\uBE44\uC2A4 \uC6CC\uCEE4 \uD65C\uC131 \uC720\uC9C0"),d(),t&&t({success:!0,timestamp:v}),!0;if(e.action==="checkNotifications")return L(),t&&t({success:!0,activeCount:u.size,lastActive:v}),!0;if(e.action==="wakeUpServiceWorker")return console.log("\uC11C\uBE44\uC2A4 \uC6CC\uCEE4 \uC6E8\uC774\uD06C\uC5C5 \uC694\uCCAD \uBC1B\uC74C"),d(),chrome.storage.sync.get(["settings"],function(n){let r=n.settings||f;r.timerStarted&&!r.isPaused&&I(),t&&t({success:!0,active:!0,timestamp:v})}),!0});function L(){return s(this,null,function*(){console.log("\uC54C\uB9BC \uC0C1\uD0DC \uD655\uC778 \uBC0F \uC815\uB9AC \uC911...");let e=Date.now(),o=0;for(let[t,n]of u.entries())n<=e&&(yield x(t),chrome.alarms.clear(y+t),u.delete(t),o++);o>0&&(console.log(`${o}\uAC1C\uC758 \uB9CC\uB8CC\uB41C \uC54C\uB9BC\uC744 \uC815\uB9AC`),S())})}_();})();
