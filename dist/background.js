(()=>{var g=(t,r,e)=>new Promise((n,o)=>{var s=a=>{try{w(e.next(a))}catch(u){o(u)}},l=a=>{try{w(e.throw(a))}catch(u){o(u)}},w=a=>a.done?n(a.value):Promise.resolve(a.value).then(s,l);w((e=e.apply(t,r)).next())});var f={interval:5,notifications:!0,exercises:!0,language:"en",categories:{neck:!0,shoulder:!0,back:!0,wrist:!0,eye:!0,arm:!0},timerStarted:!1},i="postureReminderAlarm",v="wakeUpServiceWorker",M={en:{title:"Posture Reminder",breakTime:"Break Time",breakTimeDesc:"Take a short break and do some stretching!",remindLater:"Remind in 5 minutes",stretchNow:"Stretch now"},ko:{title:"\uC790\uC138 \uC54C\uB9BC\uC774",breakTime:"\uD734\uC2DD \uC2DC\uAC04",breakTimeDesc:"\uC7A0\uC2DC \uD734\uC2DD\uC744 \uCDE8\uD558\uACE0 \uC2A4\uD2B8\uB808\uCE6D\uC744 \uD574\uBCF4\uC138\uC694!",remindLater:"5\uBD84 \uD6C4\uC5D0 \uC54C\uB9BC",stretchNow:"\uC9C0\uAE08 \uC2A4\uD2B8\uB808\uCE6D"}},c=[],d=!1,y=null,x=Date.now(),L=null,b=null;function h(t,r){return(!r||!M[r])&&(r="en"),M[r][t]||M.en[t]}function k(t){return g(this,null,function*(){t=t||"en";let r=t==="ko"?"data/exercises_kr.json":"data/exercises.json";try{console.log(`\uC6B4\uB3D9 \uB370\uC774\uD130 \uB85C\uB4DC \uC911... \uC5B8\uC5B4: ${t}, \uD30C\uC77C: ${r}`);let e=yield fetch(r);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return c=yield e.json(),console.log(`\uC6B4\uB3D9 \uB370\uC774\uD130 \uB85C\uB4DC \uC644\uB8CC: ${c.length}\uAC1C \uD56D\uBAA9`),c}catch(e){return console.error(`\uC6B4\uB3D9 \uB370\uC774\uD130 \uB85C\uB4DC \uC2E4\uD328: ${e.message}`),c=[{id:1,title:h("breakTime",t),category:"general",description:h("breakTimeDesc",t)}],console.log(`\uAE30\uBCF8 \uBA54\uC2DC\uC9C0 \uC0AC\uC6A9: ${c.length}\uAC1C \uD56D\uBAA9`),c}})}function S(){return g(this,null,function*(){return new Promise(t=>{chrome.storage.sync.get(["settings"],function(r){let e=r.settings||f;y=e,t(e)})})})}function P(){return g(this,null,function*(){let t=yield S();yield k(t.language),d=!0,t.timerStarted?(T(t.interval),I()):console.log("\uD0C0\uC774\uBA38\uAC00 \uC2DC\uC791\uB418\uC9C0 \uC54A\uC558\uC74C \uC54C\uB78C\uC744 \uC124\uC815\uD558\uC9C0 \uC54A\uC74C"),m(),N()})}function N(){L&&clearInterval(L),L=setInterval(()=>{m()},3e4)}function I(){chrome.alarms.clear(v,()=>{chrome.alarms.create(v,{delayInMinutes:.08,periodInMinutes:.08}),console.log("\uC11C\uBE44\uC2A4 \uC6CC\uCEE4 \uD65C\uC131\uD654 \uC54C\uB78C\uC774 5\uCD08 \uAC04\uACA9\uC73C\uB85C \uC124\uC815\uB428"),W()})}function W(){chrome.storage.sync.get(["settings"],function(t){let r=t.settings||f;r.timerStarted&&!r.isPaused&&chrome.alarms.get(i,e=>{let n=Date.now();e?e.scheduledTime<n-12e4?(console.log("\uBA54\uC778 \uC54C\uB78C\uC774 2\uBD84 \uC774\uC0C1 \uACFC\uAC70\uB85C \uC124\uC815\uB428, \uC7AC\uC124\uC815 \uC911..."),T(r.interval)):e.scheduledTime<n?console.log(`\uBA54\uC778 \uC54C\uB78C\uC774 \uACFC\uAC70 \uC2DC\uAC04(${Math.round((n-e.scheduledTime)/1e3)}\uCD08 \uC804)\uC73C\uB85C \uC124\uC815\uB418\uC5B4 \uC788\uC9C0\uB9CC, \uC544\uC9C1 \uCC98\uB9AC \uC911\uC77C \uC218 \uC788\uC73C\uBBC0\uB85C \uC7AC\uC124\uC815\uD558\uC9C0 \uC54A\uC74C`):console.log(`\uBA54\uC778 \uC54C\uB78C \uD655\uC778 \uC644\uB8CC, \uC608\uC815 \uC2DC\uAC04: ${new Date(e.scheduledTime).toLocaleTimeString()}, ${Math.round((e.scheduledTime-n)/1e3)}\uCD08 \uD6C4`):(console.log("\uBA54\uC778 \uC54C\uB78C\uC774 \uB204\uB77D\uB428, \uC7AC\uC124\uC815 \uC911..."),T(r.interval))})})}function m(){x=Date.now(),console.log("\uC11C\uBE44\uC2A4\uC6CC\uCEE4 \uD65C\uC131\uD654 \uC0C1\uD0DC \uC5C5\uB370\uC774\uD2B8: "+new Date().toLocaleTimeString()),chrome.storage.local.set({lastActiveTimestamp:x,serviceWorkerActive:!0})}function T(t){chrome.alarms.clear(i,()=>{chrome.alarms.create(i,{delayInMinutes:t,periodInMinutes:t}),console.log(`\uC54C\uB78C\uC774 \uC0C8\uB85C \uC124\uC815\uB428: ${t}\uBD84 \uAC04\uACA9`),console.log(`\uB2E4\uC74C \uC54C\uB78C \uC608\uC815 \uC2DC\uAC04: ${new Date(Date.now()+t*60*1e3).toLocaleTimeString()}`),m()})}function $(t){chrome.alarms.clear(i,()=>{let r=t*60*1e3,e=t;chrome.alarms.create(i,{delayInMinutes:e,periodInMinutes:t});let n=Date.now(),o=n+r;console.log(`\uC815\uD655\uD55C \uC54C\uB78C\uC774 \uC124\uC815\uB428: ${e.toFixed(4)}\uBD84 \uD6C4`),console.log(`\uC54C\uB78C \uC0DD\uC131 \uC2DC\uAC04: ${new Date(n).toLocaleTimeString()}`),console.log(`\uB2E4\uC74C \uC815\uD655\uD55C \uC54C\uB78C \uC608\uC815 \uC2DC\uAC04: ${new Date(o).toLocaleTimeString()}, \uAC04\uACA9: ${t}\uBD84`),m()})}function p(t){chrome.alarms.clear(i,()=>{chrome.storage.sync.get(["settings"],function(r){let n=(r.settings||f).interval;chrome.alarms.create(i,{delayInMinutes:t,periodInMinutes:n}),console.log(`\uC54C\uB78C\uC774 ${t.toFixed(2)}\uBD84 \uD6C4\uC5D0 \uC124\uC815\uB428, \uC774\uD6C4 ${n}\uBD84 \uAC04\uACA9\uC73C\uB85C \uBC18\uBCF5`),console.log(`\uB2E4\uC74C \uC54C\uB78C \uC608\uC815 \uC2DC\uAC04: ${new Date(Date.now()+t*60*1e3).toLocaleTimeString()}`)})})}chrome.alarms.onAlarm.addListener(t=>g(void 0,null,function*(){if(console.log(`\uC54C\uB78C \uBC1C\uC0DD: ${t.name} - ${new Date().toLocaleTimeString()}`),t.name===v){m();let r=yield S();if(r.timerStarted&&!r.isPaused){let e=yield H();e&&e-Date.now()<6e4&&(console.log("\uC54C\uB9BC \uD45C\uC2DC \uC900\uBE44 \uC911... (1\uBD84 \uC774\uB0B4 \uC54C\uB9BC \uC608\uC815)"),d||(yield k(r.language),d=!0)),chrome.alarms.get(i,n=>{let o=Date.now();n?n.scheduledTime<o-5e3&&(console.log(`\uC6E8\uC774\uD06C\uC5C5 \uCCB4\uD06C: \uBA54\uC778 \uC54C\uB78C\uC774 \uACFC\uAC70 \uC2DC\uAC04\uC73C\uB85C \uC124\uC815\uB428 (${Math.round((o-n.scheduledTime)/1e3)}\uCD08 \uC804), \uC7AC\uC124\uC815 \uC911...`),$(r.interval)):(console.log("\uC6E8\uC774\uD06C\uC5C5 \uCCB4\uD06C: \uBA54\uC778 \uC54C\uB78C\uC774 \uC5C6\uC74C, \uC7AC\uC124\uC815 \uC911..."),$(r.interval))})}return}if(t.name===i)try{let r=Date.now();console.log(`\uBA54\uC778 \uC54C\uB78C \uBC1C\uC0DD \uC2DC\uAC01: ${new Date(r).toLocaleTimeString()}`);let e=yield S();if(m(),e.isPaused){console.log("\uC77C\uC2DC \uC815\uC9C0 \uC0C1\uD0DC\uC774\uBBC0\uB85C \uC54C\uB9BC\uC744 \uD45C\uC2DC\uD558\uC9C0 \uC54A\uC74C");return}if(!e.timerStarted){console.log("\uD0C0\uC774\uBA38\uAC00 \uC911\uC9C0\uB41C \uC0C1\uD0DC\uC774\uBBC0\uB85C \uC54C\uB9BC\uC744 \uD45C\uC2DC\uD558\uC9C0 \uC54A\uC74C");return}if($(e.interval),console.log(`\uB2E4\uC74C \uC54C\uB78C \uC124\uC815 \uC644\uB8CC: ${e.interval}\uBD84 \uD6C4`),!e.notifications){console.log("\uC54C\uB9BC\uC774 \uBE44\uD65C\uC131\uD654 \uB418\uC5B4\uC788\uC74C");return}if(e.workHoursOnly&&!U(e.workStart,e.workEnd)){console.log("\uD604\uC7AC \uC2DC\uAC04\uC774 \uADFC\uBB34 \uC2DC\uAC04\uC774 \uC544\uB2C8\uBBC0\uB85C \uC54C\uB9BC\uC744 \uD45C\uC2DC\uD558\uC9C0 \uC54A\uC74C");return}(!d||c.length===0)&&(yield k(e.language),d=!0),b=yield E(e),console.log("\uC54C\uB9BC \uD45C\uC2DC \uC2DC\uC791...");try{yield _(e),console.log("\uC54C\uB9BC \uD45C\uC2DC \uC644\uB8CC")}catch(o){console.error("\uC54C\uB9BC \uD45C\uC2DC \uC911 \uC624\uB958 \uBC1C\uC0DD:",o)}let n=Date.now()-r;console.log(`\uC54C\uB78C \uCC98\uB9AC \uC18C\uC694 \uC2DC\uAC04: ${n}ms`),setTimeout(()=>{chrome.alarms.get(i,o=>{o?console.log(`\uC54C\uB78C \uC124\uC815 \uD655\uC778: ${new Date(o.scheduledTime).toLocaleTimeString()}\uC5D0 \uC608\uC815\uB428`):(console.error("\uC54C\uB78C\uC774 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC74C! \uAE34\uAE09 \uC7AC\uC124\uC815 \uC2DC\uB3C4"),$(e.interval))})},2e3)}catch(r){console.error("\uC54C\uB78C \uCC98\uB9AC \uC911 \uC624\uB958 \uBC1C\uC0DD:",r);try{let e=yield S();$(e.interval),console.log("\uC624\uB958 \uBC1C\uC0DD \uD6C4 \uC54C\uB78C \uC7AC\uC124\uC815 \uC2DC\uB3C4 \uC644\uB8CC")}catch(e){console.error("\uC624\uB958 \uBCF5\uAD6C \uC2E4\uD328:",e)}}}));function H(){return new Promise(t=>{chrome.alarms.get(i,r=>{t(r?r.scheduledTime:null)})})}function E(t){return g(this,null,function*(){let r=t.language||"en",e={title:h("breakTime",r),description:h("breakTimeDesc",r)};if(t.exercises&&c.length>0){let n=c.filter(o=>{let s=t.categories||f.categories;return s[o.category]===void 0?!0:s[o.category]===!0});if(n.length===0)console.log("\uC120\uD0DD\uB41C \uCE74\uD14C\uACE0\uB9AC\uC5D0 \uC0AC\uC6A9 \uAC00\uB2A5\uD55C \uC6B4\uB3D9\uC5C6\uC74C. \uAE30\uBCF8 \uBA54\uC2DC\uC9C0\uB97C \uC0AC\uC6A9 \uD568.");else{let o=Math.floor(Math.random()*n.length);e=n[o],console.log(`\uC120\uD0DD\uB41C \uC6B4\uB3D9: ${e.title} (${e.category})`)}}return e})}function U(t,r){let e=new Date,n=e.getHours(),o=e.getMinutes(),[s,l]=t.split(":").map(Number),[w,a]=r.split(":").map(Number),u=n*60+o,D=s*60+l,A=w*60+a;return console.log(`\uD604\uC7AC \uC2DC\uAC04: ${n}:${o} (${u}\uBD84)`),console.log(`\uADFC\uBB34 \uC2DC\uC791: ${s}:${l} (${D}\uBD84)`),console.log(`\uADFC\uBB34 \uC885\uB8CC: ${w}:${a} (${A}\uBD84)`),A<D?u>=D||u<=A:u>=D&&u<=A}function _(t){return g(this,null,function*(){console.log("\uC54C\uB9BC \uD45C\uC2DC \uC911...");let r=t.language||"en",e=b||(yield E(t)),n="posture-reminder-"+Date.now();try{yield new Promise((o,s)=>{chrome.notifications.create(n,{type:"basic",iconUrl:"assets/images/icon128.png",title:h("title",r),message:`${e.title}: ${e.description}`,priority:2,buttons:[{title:h("remindLater",r)},{title:h("stretchNow",r)}],requireInteraction:!1},l=>{chrome.runtime.lastError?s(chrome.runtime.lastError):o(l)})}),console.log(`\uC54C\uB9BC \uD45C\uC2DC\uB428: ${n}, \uC790\uB3D9\uC73C\uB85C \uB2EB\uD798\uC774 \uD5C8\uC6A9\uB428`)}catch(o){console.error("\uC54C\uB9BC \uC0DD\uC131 \uC911 \uC624\uB958 \uBC1C\uC0DD:",o)}})}chrome.notifications.onButtonClicked.addListener((t,r)=>g(void 0,null,function*(){r===0?p(5):chrome.tabs.create({url:"popup/stretching_guide.html"}),chrome.notifications.clear(t)}));chrome.storage.onChanged.addListener((t,r)=>g(void 0,null,function*(){if(r==="sync"&&t.settings){let e=t.settings.newValue;y=e,e.timerStarted&&!e.isPaused?(T(e.interval),console.log(`\uC124\uC815 \uBCC0\uACBD \uAC10\uC9C0: \uD0C0\uC774\uBA38 \uC2DC\uC791\uB428, ${e.interval}\uBD84 \uAC04\uACA9\uC73C\uB85C \uC54C\uB78C \uC124\uC815`)):console.log("\uC124\uC815 \uBCC0\uACBD \uAC10\uC9C0: \uD0C0\uC774\uBA38 \uC2DC\uC791\uB418\uC9C0 \uC54A\uC558\uAC70\uB098 \uC77C\uC2DC \uC815\uC9C0 \uC0C1\uD0DC, \uC54C\uB78C \uC124\uC815 \uC548 \uD568"),(!t.settings.oldValue||t.settings.oldValue.language!==e.language)&&(yield k(e.language),d=!0)}}));chrome.runtime.onMessage.addListener((t,r,e)=>{if(console.log("\uBA54\uC2DC\uC9C0 \uC218\uC2E0:",t.action),m(),t.action==="resetAlarm")return chrome.storage.sync.get(["settings"],function(n){let o=n.settings||f;y=o,o.timerStarted?t.immediate?(console.log("\uC989\uC2DC \uC54C\uB78C \uC7AC\uC124\uC815 \uC694\uCCAD \uCC98\uB9AC \uC911..."),chrome.alarms.clear(i,()=>{let s=Date.now()+o.interval*60*1e3;chrome.alarms.create(i,{when:s,periodInMinutes:o.interval}),console.log(`\uC989\uC2DC \uC54C\uB78C \uC7AC\uC124\uC815 \uC644\uB8CC: \uB2E4\uC74C \uC54C\uB78C ${o.interval}\uBD84 \uD6C4 (${new Date(s).toLocaleTimeString()})`),e&&e({success:!0,message:"\uC54C\uB78C \uC989\uC2DC \uC7AC\uC124\uC815 \uC644\uB8CC",nextAlarmAt:s}),setTimeout(()=>{chrome.alarms.get(i,l=>{l?console.log(`\uC54C\uB78C \uD655\uC778: ${new Date(l.scheduledTime).toLocaleTimeString()}`):(console.error("\uC54C\uB78C \uC124\uC815 \uC2E4\uD328! \uC7AC\uC2DC\uB3C4\uD569\uB2C8\uB2E4."),chrome.alarms.create(i,{when:s,periodInMinutes:o.interval}))})},500)})):(T(o.interval),console.log("\uD0C0\uC774\uBA38\uAC00 \uC2DC\uC791\uB428: \uC54C\uB78C \uC124\uC815\uB428"),chrome.alarms.get(i,s=>{e&&e({success:!0,message:"\uC54C\uB78C \uC124\uC815\uB428",nextAlarmAt:s?s.scheduledTime:Date.now()+o.interval*60*1e3})})):(console.log("\uD0C0\uC774\uBA38\uAC00 \uC2DC\uC791\uB418\uC9C0 \uC54A\uC558\uC74C: \uC54C\uB78C\uC744 \uC124\uC815\uD558\uC9C0 \uC54A\uC74C"),e&&e({success:!1,message:"\uD0C0\uC774\uBA38 \uC911\uC9C0\uB428"}))}),!0;if(t.action==="resumeAlarm"&&t.delayInMinutes)return p(t.delayInMinutes),e&&e({success:!0,message:"\uC54C\uB78C \uC7AC\uAC1C"}),!0;if(t.action==="startTimer")return chrome.storage.sync.get(["settings"],function(n){let o=n.settings||f;o.timerStarted=!0,o.isPaused=!1,y=o,chrome.storage.sync.set({settings:o},function(){T(o.interval),I(),console.log("\uD0C0\uC774\uBA38 \uC2DC\uC791 \uC694\uCCAD: \uC54C\uB78C \uC124\uC815\uB428"),e&&e({success:!0,message:"\uD0C0\uC774\uBA38 \uC2DC\uC791"})})}),!0;if(t.action==="stopTimer")return chrome.storage.sync.get(["settings"],function(n){let o=n.settings||f;o.timerStarted=!1,o.isPaused=!1,y=o,chrome.storage.sync.set({settings:o},function(){chrome.alarms.clear(i),chrome.alarms.clear(v),console.log("\uD0C0\uC774\uBA38 \uC911\uC9C0 \uC694\uCCAD: \uBAA8\uB4E0 \uC54C\uB78C \uC81C\uAC70"),e&&e({success:!0,message:"\uD0C0\uC774\uBA38 \uC911\uC9C0"})})}),!0;if(t.action==="getExercises")return!d||c.length===0?S().then(n=>{k(n.language).then(o=>{d=!0,e&&e({success:!0,exercises:o})})}):e&&e({success:!0,exercises:c}),!0;if(t.action==="keepAlive")return console.log("\uD0B5\uC5BC\uB77C\uC774\uBE0C \uBA54\uC2DC\uC9C0 \uC218\uC2E0, \uC11C\uBE44\uC2A4 \uC6CC\uCEE4 \uD65C\uC131 \uC720\uC9C0"),m(),e&&e({success:!0,timestamp:x}),!0;if(t.action==="wakeUpServiceWorker")return console.log("\uC11C\uBE44\uC2A4 \uC6CC\uCEE4 \uC6E8\uC774\uD06C\uC5C5 \uC694\uCCAD \uBC1B\uC74C"),m(),chrome.storage.sync.get(["settings"],function(n){let o=n.settings||f;o.timerStarted&&!o.isPaused&&I(),e&&e({success:!0,active:!0,timestamp:x})}),!0});P();})();
